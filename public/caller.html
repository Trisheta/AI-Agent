<!DOCTYPE html>
<html>
<head>
  <title>Caller</title>
</head>
<body>
  <h2>Caller</h2>
  <button onclick="startCall()">Start Call</button>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const peer = new RTCPeerConnection();
    const callerId = "caller";

    socket.emit("register", callerId);

    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      stream.getTracks().forEach(track => peer.addTrack(track, stream));
    });

    peer.onicecandidate = e => {
      if (e.candidate) {
        socket.emit("send-ice-candidate", {
          to: "ai-agent",
          candidate: e.candidate
        });
      }
    };

    socket.on("answer-made", async data => {
      await peer.setRemoteDescription(new RTCSessionDescription(data.answer));
    });

    socket.on("ice-candidate", ({ candidate }) => {
      peer.addIceCandidate(new RTCIceCandidate(candidate));
    });

    async function startCall() {
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);
      socket.emit("call-user", {
        offer: offer,
        to: "ai-agent"
      });
    }
  </script>
</body>
</html>
